#!/usr/bin/python
import sys
import os
import optparse
import logging

from mdv.sec.tasks import Interface, Config, SecteamTasks

def parse_options(args):
    def parse_option(option, opt_str, value, parser, *args, **kwargs):
        kv = value.split("=", 1)
        if len(kv) != 2:
           raise optparse.OptionValueError, "-o accepts values only in "\
                   "the name=value form"
        levels = kv[0].split(".")
        lastv = kv[1]
        for name in levels[:0:-1]:
            lastv = {name: lastv}
        parser.values.config_options[levels[0]] = lastv
    parser = optparse.OptionParser("%prog [options]")
    parser.set_defaults(config_options={})
    parser.add_option("-e", "--easy-tickets", action="store_true",
            default=False, help="show easy to fix tickets")
    parser.add_option("-s", "--status", action="store_true", default=False,
            help="show the status of the tickets for each distro")
    parser.add_option("-v", "--verbose", action="store_true", default=False)
    parser.add_option("--pull-cves", action="store_true", default=False,
            help="pull cves from a MITRE's XML text file")
    parser.add_option("--init", action="store_true", default=False,
            help="create initial directory structure needed for sekt")
    parser.add_option("-o", "--option", type="string", action="callback",
            callback=parse_option,
            help="set one configuration option in the form opt=val")
    parsed = parser.parse_args(args)
    return parsed

def main():
    options, args = parse_options(sys.argv)
    if options.verbose:
        logging.basicConfig(level=logging.DEBUG)
    else:
        logging.basicConfig(level=logging.ERROR)
    config = Config()
    config.merge(options.config_options)
    path = (os.environ.get(config.conf.path_environment) or
            os.path.expanduser(os.path.join("~", config.conf.user_file)))
    if os.path.exists(path):
        config.load(path)
    tasks = SecteamTasks(config)
    interface = Interface(config, tasks)
    try:
        try:
            if options.easy_tickets:
                interface.easy_tickets()
            if options.status:
                interface.status()
            if options.pull_cves:
                interface.pull_cves()
            if options.init:
                interface.init()
        finally:
            tasks.finish()
    except KeyboardInterrupt:
        sys.stderr.write("interrupted\n")
        sys.exit(1)

if __name__ == "__main__":
    main()
